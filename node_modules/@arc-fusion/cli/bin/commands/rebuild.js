'use strict'

const path = require('path')

const {
  FUSION_RELEASE,
  PROJECT_ROOT
} = require('../environment')

const {
  dockerList
} = require('../utils/docker')

const spawn = require('../utils/spawn')

async function rebuild20 () {
  const engineProcess = (await dockerList('ps'))
    .find((ps) => ps.includes(':9010->'))

  if (engineProcess) {
    const engineProcessId = engineProcess.split(/\s+/g)[0]
    return spawn('docker', ['exec', engineProcessId, 'npm', 'run', 'build:all'], { stdio: 'inherit' })
  }
}

async function rebuild () {
  return spawn(
    'docker-compose',
    ['-f', path.join('.fusion', 'docker-compose.yml'), 'restart', 'webpack'],
    {
      cwd: PROJECT_ROOT,
      stdio: 'inherit'
    }
  )
}

module.exports = (/^(2\.0\.|2\.0$)/i.test(FUSION_RELEASE))
  ? rebuild20
  : rebuild
