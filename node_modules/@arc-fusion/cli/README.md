# Arc Fusion CLI

This is the CLI tool for running Arc Fusion on your local machine.

## Requirements

The following apps/commands are required for the fusion CLI to function properly:

-   [node](https://nodejs.org/en/download/)
-   [npm](https://docs.npmjs.com/getting-started/installing-node)
-   [docker](https://docs.docker.com/install/)
-   [docker-compose](https://docs.docker.com/compose/install/#install-compose)

## Installation

### Global install

```sh
npm install -g @arc-fusion/cli
```

will install a command-line script on your system, globally accessible as `fusion`.

### Local install

```sh
npm install --save-dev @arc-fusion/cli
```

will install a command-line script in your repo, locally accessible as `npx fusion` or `npm run fusion`.

## Testing
To test the CLI, you can either use `npm link` in the local folder and `npm link @arc-fusion/cli` in the repo or you can run `npm install --no-save [path to local folder]` in the repo where you want to test it out. Then just run the command you need to test with `npx fusion <command>`.

## Publishing
First, make sure you have read/write access for the `@arc-fusion` org, as well as the cli repo itself at https://www.npmjs.com/package/@arc-fusion/cli. If you haven't already, enable Two-Factor Authentication, because by default we have the setting to require 2FA for modifying the module. Make sure you have also logged into your npm account through the npm cli with the one that has access to the `@arc-fusion` org.

For releasing a new version, run `npm version patch`, and it will both increment the cli version and publish it to the public.

> **NOTE**
> `npm version` is wired to `npm publish`, so careful not to use it for just incrementing the version.
>

If you need to add a tag, such as `beta`, you can run the command `npm dist-tag add --otp=[2FA token] @arc-fusion/cli@[VERSION] [TAG]`. Likewise, if you need to remove a tag, you can do so with `npm dist-tag rm --otp=[2FA token] @arc-fusion/cli [TAG]`. 

## Commands

All commands should be run from within the repository, as `fusion <command>` if installed globally, or `npx fusion <command>` if installed locally.

### down

Stop and remove containers, networks, images, and volumes

### dump

Export the database into `data/dumps/<timestamp>.tar.gz`

### init

Initialize the directory as a git repo, an npm package, and bootstrap the fusion directory structure

### migrate

Migrate a legacy fusion repository to work with the fusion CLI

### rebuild

Force a webpack rebuild of a running cluster

### start [--no-admin]

Configure a docker-compose cluster to map npm linked modules, then start services.

This is also aliased as `npm start` for convenience.

The start command may also be run with the `--no-admin` flag to run the rendering services without the admin app.

If `FUSION_REPO` is set in the `.env` file of the repo, the local version of fusion will be used for development. This should be the absolute path to the directory the local fusion repo is in.

For themes development, there are a few additional flags you can use:

* `-l` or `--link`: Use the local version of blocks for developement. Can optionally take a comma separated string of blocks to link instead of linking all of them (`-l @org/block1,@org/block2`). This requires that you have `THEMES_BLOCKS_REPO` set in your `.env` file and it should be the absolute path to the directory the local blocks repo is in.
* `-f` or `--rebuild`: Rebuild the webpack image and pull the latest version of the blocks.
* `-p` or `--production`: Force the image to use the production blocks even if `useLocal` is set to true.

We also allow a few additional environment variables (set in the repo's `.env` file):

* `ENGINE_SDK_REPO`: This is used only for themes development. If set, this will use the local version of the engine sdk for development. This should be the absolute path to the directory the local engine sdk repo is in.
* `CSS_FRAMEWORK_REPO`: This is used only for themes development. If set, this will use the local version of the css framework for development. This should be the absolute path to the directory the local css framework repo is in.
* `BLOCK_DIST_TAG`: This is used only for themes development. If set, this will control the version of all installed blocks that don't specify a version. The default is `stable`.
* `ENGINE_HEAP_SIZE`: If set, this changes the amount of memory (in MB) the engine image's node is allowed to use. The default is `2048`.
* `WEBPACK_HEAP_SIZE`: If set, this changes the amount of memory (in MB) the webpack image's node is allowed to use. The default is `4096`.
* `FUSION_RELEASE`: If set, this changes the verison of Fusion used for the engine and webpack images. The default is `latest`.

### stop

Stop services

### verify

Run webpack on the repo source to ensure it has no compilation errors

### zip

Create a zip file that is appropriate for upload into the fusion deployment system
