'use strict'

const path = require('path')

const { dirExists } = require('../bin/utils/promises')

module.exports = async ({ PROJECT_ROOT }) => {
  const hasScripts = await dirExists(path.join(PROJECT_ROOT, 'scripts'))

  return `
ARG FUSION_RELEASE=latest
FROM washpost/fusion-engine:\${FUSION_RELEASE}

# must use COPY instead of volume to get proper file system case-sensitivity
COPY ./ ./bundle/src/
${hasScripts ? 'COPY ./scripts/ ./bundle/scripts/' : ''}

# ensure we install node_modules from package.json
RUN rm -rf ./bundle/src/node_modules
`
}
