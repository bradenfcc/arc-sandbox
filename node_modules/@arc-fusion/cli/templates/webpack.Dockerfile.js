'use strict'

const path = require('path')

const { dirExists, fileExists } = require('../bin/utils/promises')

module.exports = async ({ PROJECT_ROOT, rebuild, localFusion, themesVersion }) => {
  const hasScripts = await dirExists(path.join(PROJECT_ROOT, 'scripts'))
  const hasNPMRC = await fileExists(path.join(PROJECT_ROOT, '.npmrc'))
  const hasBlocks = await fileExists(path.join(PROJECT_ROOT, 'blocks.json'))
  return `
ARG FUSION_RELEASE=latest
FROM ${localFusion ? '' : 'washpost/fusion-engine:'}\${FUSION_RELEASE}
${hasBlocks ? `ENV BLOCK_DIST_TAG=${themesVersion || 'stable'}` : ''}
${rebuild ? `RUN echo "rebuilding at ${Date.now()}"` : ''}
# package.json and .npmrc will be copied from ./bundle/src/ back into ./bundle/
COPY ./package*.json ./bundle/src/
${hasScripts ? 'COPY ./scripts/ ./bundle/scripts/' : ''}
${hasNPMRC ? 'COPY ./.npmrc ./bundle/src/' : ''}
${hasBlocks ? 'COPY ./blocks.json ./bundle/src': ''}
RUN npm run install:bundle
`
}
